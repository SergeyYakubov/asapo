job "asapo-test" {
  datacenters = [
    "dc1"]

  type = "batch"

  group "filegen-windows" {

    constraint {
      attribute = "${attr.kernel.name}"
      value = "windows"
    }

    count = 1

    task "filegen" {
      driver = "raw_exec"

      config {
        command = "local/filegen_win.exe"
        args = [
          "1",
          "1M",
          "100000",
          "1100",
          "u:/asapo/test_folder/file_win"]
      }

      artifact {
        source = "http://nims.desy.de/extra/asapo/filegen_win.exe"
        mode = "file"
        destination = "local/filegen_win.exe"
      }
    }


  }
  #windows

  group "filegen-linux" {

    constraint {
      attribute = "${attr.kernel.name}"
      value = "linux"
    }

    constraint {
      attribute = "${meta.location}"
      value = "petra3"
    }

    count = 1

    task "filegen" {
      driver = "raw_exec"

      config {
        command = "local/filegen_linux"
        args = [
          "1",
          "1M",
          "100000",
          "1200",
          "/run/user/data/file_lin"]
      }

      artifact {
        source = "http://nims.desy.de/extra/asapo/filegen_linux"
        mode = "file"
        destination = "local/filegen_linux"
      }
    }

  }


  group "consumer" {

    restart {
      attempts = 0
    }


    constraint {
      attribute = "${attr.kernel.name}"
      value = "linux"
    }

    #    constraint {
    #      attribute = "${meta.location}"
    #      operator = "!="
    #      value = "petra3"
    #    }

    count = 1

    task "consumer-linux" {
      driver = "raw_exec"
    template {
     data = <<EOH
        CONSUMER_READ_META_ONLY = "{{ keyOrDefault "consumer_read_meta_only" "1" }}"
        EOH
     destination = "secrets/file.env"
     env         = true
    }

      config {
        command = "local/getnext_broker"
        args = [
          "psana002:8400",
          "/bldocuments/support/asapo/data/test1/asapo_test1",
          "asapo_test",
          "16",
          "KmUDdacgBzaOD3NIJvN1NmKGqWKtx0DK-NyPjdpeWkc=",
          "30000",
          "${CONSUMER_READ_META_ONLY}",
          "1"]
      }

#      resources {
#        cpu = 5000
#        memory = 128
#        network {
#          mbits = 10000
#        }
#      }

      artifact {
        source = "http://nims.desy.de/extra/asapo/getnext_broker-@ASAPO_VERSION@"
        mode = "file"
        destination = "local/getnext_broker"
      }
    }

  }
  # consumer

}
